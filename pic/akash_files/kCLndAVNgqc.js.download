if (self.CavalryLogger) { CavalryLogger.start_js(["Sq3xo"]); }

__d("FBRTCIncomingCallController",["fbt","requireCond","Cache","CurrentUser","DocumentTitle","FBRTCCallBlockingStore","FBRTCCallSummary","FBRTCCallSummaryStore","FBRTCCallUIWrapper","FBRTCConstants","FBRTCLocalMessageQueue","FBRTCLocalUploadLogLevel","FBRTCLogger","FBRTCMessage","FBRTCMessageDedup","FBRTCMessageSender","FBRTCSupport","MercuryIDs","MessengerBrowserAlerts","MessengerParticipants.bs","RTWebExperiments","UserActivity","cr:1516189"],(function(a,b,c,d,e,f,g){var h=30;a=function(){"use strict";function a(a,c,d){this.$12=null,this.$1=null,this.$2=a,this.$3=c,this.$4=d,this.$5=null,this.$6=null,this.$7=new(b("FBRTCMessageSender"))(),this.$8=b("FBRTCCallSummaryStore").getInstance(),this.$9=b("FBRTCLogger").getInstance(),this.$10=null,this.$11=new(b("Cache"))()}var c=a.prototype;c.setCustomAnswerHandler=function(a){this.$12=a};c.onMessageReceived=function(a){var c;try{c=new(b("FBRTCMessage"))(a)}catch(b){this.$9.logErrorWithoutID("Unknown data: "+JSON.stringify(a));return}if(c.selfID!=null&&c.selfID!==b("CurrentUser").getID()){this.$9.logInfo(c.peerID,c.callID,"Ignoring message (wrong receiver): "+c.msgID);return}if(!b("FBRTCMessageDedup").check(c.peerID,c.callID,c.msgID)){c.isOffer()&&this.$13()&&this.$7.sendOfferAck(c.peerID,c.callID,c.msg);this.$9.logInfo(c.peerID,c.callID,"Ignoring message (duplicate): "+c.msgID);return}this.$9.logReceivedMessage(c.peerID,c.callID,c.msg);!b("RTWebExperiments").enableCallCollisionFix()&&b("FBRTCSupport").isWebrtcSupported()&&c.msgType!==b("FBRTCConstants").PayloadType.OFFER&&b("FBRTCLocalMessageQueue").enqueueMessage(c.peerID,c.msgID,a);switch(c.msgType){case b("FBRTCConstants").PayloadType.OFFER:this.$14(c);break;case b("FBRTCConstants").PayloadType.HANGUP:this.$15(c);break;case b("FBRTCConstants").PayloadType.OTHER_DISMISS:this.$16(c);break;case b("FBRTCConstants").PayloadType.ICE_CANDIDATE:case b("FBRTCConstants").PayloadType.OFFER_ACK:case b("FBRTCConstants").PayloadType.ANSWER:case b("FBRTCConstants").PayloadType.MSG_ACK:case b("FBRTCConstants").PayloadType.OK:case b("FBRTCConstants").PayloadType.PING:case b("FBRTCConstants").PayloadType.PRANSWER:case b("FBRTCConstants").PayloadType.ICERESTART_OFFER:case b("FBRTCConstants").PayloadType.ICERESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_OFFER:case b("FBRTCConstants").PayloadType.SDP_UPDATE:case b("FBRTCConstants").PayloadType.ANSWER_ACK:case b("FBRTCConstants").PayloadType.SET_VIDEO:case b("FBRTCConstants").PayloadType.OFFER_NACK:case b("FBRTCConstants").PayloadType.VIDEO_REQUEST:case b("FBRTCConstants").PayloadType.ACK:break;default:break}};c.$14=function(a){var c=this,d=a.callID,e=a.msg,f=a.peerID;if(this.$17(d))return;if(e.calltype){this.$7.sendOfferNack(f,d,e);return}this.$13()?this.$7.sendOfferAck(f,d,e):this.$7.sendOfferNack(f,d,e);this.$9.logCallAction(f,d,b("FBRTCLogger").CallAction.RECEIVED_CALL);var g=this.$18(f,d,a);g.setUploadLogLevel(b("FBRTCLocalUploadLogLevel").getUploadLogLevel(b("FBRTCConstants").convertToUploadLogLevel(e.ull)));var h=b("CurrentUser").isWorkUser()&&b("cr:1516189")!=null&&b("cr:1516189").getIsDoNotDisturb(b("CurrentUser").getID());if(b("FBRTCCallBlockingStore").getBlockingStatus()||h){this.$19(f,d,g,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!1,!1,"calling disabled");return}h=this.$2.getCallEndReasonForNewRequest();if(this.$5&&!this.$5.isForPeer(f)||h===b("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL){this.$19(f,d,g,b("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL,!1,!1,!0);this.$4.onCallMissed(f);return}if(!b("FBRTCSupport").isWebrtcSupported()){this.$19(f,d,g,b("FBRTCConstants").CallEndReason.UNSUPPORTED_VERSION,!1,!1,!1);this.$3.showForIncomingCall(d,f);this.$20();return}h=new this.$2(f,d);this.$6=g;h.addListener("answerCall",function(b,e){c.$20(),c.$21(f,d,a,g,e)});h.addListener("ignoreCall",function(){c.$20(),c.$22(f,d,g)});h.addListener("timeout",function(){c.$20(),c.$23(f,d,g)});this.$4.hideDialog();e=e.videoon?b("FBRTCConstants").IncomingCallDialogTypes.VIDEO:b("FBRTCConstants").IncomingCallDialogTypes.AUDIO;h.showIncomingDialog(e);this.$5=h;this.$9.logEvent(f,d,"Incoming call dialog shown");this.$24(f);this.$25(a,g)};c.$24=function(a){document.hasFocus()||this.$26(a)};c.$27=function(){this.$28()};c.$26=function(a){var c=this;a=b("MercuryIDs").getParticipantIDFromUserID(a);b("MessengerParticipants.bs").get(a,function(a){if(!c.$5)return;c.$10=b("DocumentTitle").blink(g._("{name} is calling",[g._param("name",a.short_name)]))});b("UserActivity").subscribeOnce(this.$28.bind(this))};c.$25=function(a,c){var d=this,e=a.callID,f=a.msg,g=a.peerID,h=f.videoon;f={callID:e,peerID:g,onNotificationClicked:function(){d.$5!=null&&d.$5.cancel(),d.$21(g,e,a,c,h)},isVideoCall:h,isGroupCall:!1};b("MessengerBrowserAlerts").showRTCNotification(f,function(a){d.$1=a})};c.$20=function(){this.$1&&(this.$1.close(),this.$1=null)};c.$28=function(){this.$10&&(this.$10.stop(),this.$10=null)};c.$29=function(){this.$5&&this.$5.cancel(),this.$5=null,this.$6=null,this.$27()};c.$15=function(a){var c=a.peerID,d=a.callID;a=a.msg;this.$30(d);if(this.$5&&this.$5.isForPeerAndCall(c,d)){a=a.reason;(typeof a==="string"||a instanceof String)&&(a=b("FBRTCConstants").endCallReasonFromString(a));this.$19(c,d,this.$6,a,!0,!0,!1);this.$29();a!==b("FBRTCConstants").CallEndReason.OTHER_INSTANCE_HANDLED&&(this.$4.onCallMissed(c),this.$4.showDialog())}};c.$13=function(){return b("FBRTCSupport").isWebrtcSupported()};c.$16=function(a){a=a.callID;this.$30(a);b("FBRTCSupport").isWebrtcSupported()||this.$3.dismiss();this.$5&&this.$5.isForCall(a)&&this.$29()};c.$30=function(a){this.$11.set(a,!0,null,h)};c.$17=function(a){return this.$11.has(a)};c.$18=function(a,c,d){a=new(b("FBRTCCallSummary"))({peerID:a,callID:c,isCaller:!1});a.setCallTrigger("incoming_p2p_ring_dialog");a.setActiveConnection("p2p");a.onFullMessageReceived(d);a.onOfferAckSent(d.msg);return a};c.$21=function(a,c,d,e,f){var g=!d.msg.videoon;e.onPressedAnswer();e.save(this.$8);this.$9.logCallAction(a,c,b("FBRTCLogger").CallAction.ANSWER_CALL);this.$7.sendOtherDismiss(c);!b("RTWebExperiments").passOfferWithWindowMessages()?b("FBRTCLocalMessageQueue").writePeerOfferToStorage(a,d.originalMessageData):b("RTWebExperiments").enableCallCollisionFix()||b("FBRTCLocalMessageQueue").enqueueMessage(a,d.msgID,d.originalMessageData);d=this.$12;d?d({peerID:a,callID:String(c),callSummary:e,initializeVideo:f,isAudioCall:g}):b("FBRTCCallUIWrapper").openAsCallee(a,c,e,g,f);this.$29()};c.$22=function(a,c,d){this.$19(a,c,d,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!0,!0),this.$29()};c.$23=function(a,c,d){this.$19(a,c,d,b("FBRTCConstants").CallEndReason.NO_ANSWER_TIMEOUT,!1,!1,!1),this.$29(),this.$4.onCallMissed(a),this.$4.showDialog()};c.$19=function(a,c,d,e,f,g,h,i){i===void 0&&(i=null);h&&this.$7.sendHangup(a,c,e);g&&this.$7.sendOtherDismiss(c);d&&(d.onCallEnded(e,f,null,i),d.save(this.$8));h=b("FBRTCConstants").fullCallEndReasonString(e,f);this.$9.logCallAction(a,c,b("FBRTCLogger").CallAction.END_CALL,h)};return a}();e.exports=a}),null);
__d("ZenonOfferStorage",["CacheStorage"],(function(a,b,c,d,e,f){"use strict";var g="localstorage",h="RTC_",i="offer",j="offer_msg",k={_storeData:function(a,b,c){c={__d:c,__t:Date.now()};a.set(b,c)},getStorage:function(a,c){return new(b("CacheStorage"))(g,""+h+a+"_"+c+"_")},writePeerOfferToStorage:function(a,b){a=k.getStorage(a,j);k._storeData(a,i,b)}};e.exports=k}),null);
__d("ZenonP2PMessageDedup",[],(function(a,b,c,d,e,f){"use strict";a=function(){function a(){this.$1={}}var b=a.prototype;b.isDuplicate=function(a){var b=a.call_id,c=a.from;a=a.id;this.$1[c]||(this.$1[c]={});this.$1[c][b]||(this.$1[c][b]={});if(this.$1[c][b][a])return!0;this.$1[c][b][a]=!0;return!1};return a}();e.exports=a}),null);
__d("ZenonSignalingParentTransport",["FBLogger","FBRTCSupport","Random","URI","ZenonOfferStorage","ZenonP2PMessageDedup","ZenonP2PMessageTypes","ZenonPlatformExperiments","ZenonSignalingTransportTypes","isFacebookishURI","recoverableViolation"],(function(a,b,c,d,e,f){"use strict";var g,h=b("ZenonP2PMessageTypes").ZenonP2PSignalingPayloadType,i=b("ZenonSignalingTransportTypes").ChildTransportMessageType,j=10*60*1e3,k=45*1e3;a=function(){function a(){var a=this;this.verificationNonce=null;this.portToChild=null;this.$1=null;this.$2=null;this.$3=new Map();this.$4=new Map();this.$5=new(b("ZenonP2PMessageDedup"))();this.$6=new Map();b("FBRTCSupport").isWebrtcSupported()&&window.addEventListener&&window.addEventListener("message",function(b){a.handleWindowMessageFromChild(b)},!1)}var c=a.prototype;c.handleWindowMessageFromChild=function(a){var b=this;if(this.windowMessageValid(a)&&a.data.type===i.CHILD_WINDOW_READY&&this.hasPort(a)){var c;c=(c=a.data.roomID)!=null?c:null;this.portToChild=a.ports[0];a=a.data;var d=a.childNonce;a=a.peerID;this.$2=d;window.clearTimeout(this.$1);this.$1=window.setTimeout(function(){b.portToChild=null},k);this.verificationNonce=this.generateNonce();this.startCallInChildWindow(c);this.$7(a)}};c.generateNonce=function(){return String(b("Random").random())};c.hasPort=function(a){return Boolean(a.ports!=null&&Array.isArray(a.ports)&&a.ports[0]!=null)};c.startCallInChildWindow=function(a){var c=null;if(b("ZenonPlatformExperiments").isMwpp()&&a!=null){c=(a=this.$3.get(a))!=null?a:null}a={mwRingRequest:c,nonce:this.$2,offer:null,type:i.PARENT_INITIATED_CALL};this.sendMessageToChild(a)};c.windowMessageValid=function(a){return Boolean(a.origin===window.location.origin||b("isFacebookishURI")(new(g||(g=b("URI")))(a.origin))&&b("isFacebookishURI")(new(g||(g=b("URI")))(window.location.origin)))&&this.postMessageValid(a)};c.postMessageValid=function(a){return Boolean(this.verificationNonce!==null&&(a==null?void 0:(a=a.data)==null?void 0:a.nonce)===this.verificationNonce)};c.$7=function(a){var b;b=(b=this.$4.get(a))!=null?b:[];var c=Date.now();b=b.map(function(a){return a.time<=c-j?null:a.value}).filter(Boolean);for(var b=b,d=Array.isArray(b),e=0,b=d?b:b[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(d){if(e>=b.length)break;f=b[e++]}else{e=b.next();if(e.done)break;f=e.value}f=f;this.sendSignalingMessageToChild(f)}this.$4["delete"](a)};c.sendSignalingMessageToChild=function(a){a={message:a,nonce:this.$2,type:i.PARENT_TO_CHILD_MESSAGE};this.sendMessageToChild(a)};c.sendMessageToChild=function(a){this.portToChild!=null?this.portToChild.postMessage(a):b("recoverableViolation")("The child window port should be available","rtc_www")};c.enqueueRawMWMessage=function(a){var b=a.jsonPayload,c=b.body;b=b.header;c=c.ringRequest;if(c){c=b.conferenceName;this.$3.set(c,a)}};c.enqueueRawP2PMessage=function(a){if(this.$5.isDuplicate(a))return;var b=String(a.from);if(a.msg_type===h.OFFER){this.$8(a);return}this.portToChild!=null&&this.sendSignalingMessageToChild(a);var c=this.$4.get(b);c||(c=[],this.$4.set(b,c));c.push({time:Date.now(),value:a})};c.testGetChildNonce=function(){return this.$2};c.storeOfferForBackwardsCompat=function(a,c){var d=this.$9(a,c);if(d===null){b("FBLogger")("rtc_www").mustfix("P2P callee child window opening with no offer in storage.",a,c);return}b("ZenonOfferStorage").writePeerOfferToStorage(a,d)};c.$9=function(a,b){a=a+","+b;return(b=this.$6.get(a))!=null?b:null};c.$8=function(a){var b=a.call_id,c=String(a.from);c=c+","+b;this.$6.set(c,a)};return a}();e.exports=a}),null);